#!/bin/bash
# script to generate a list of IPs to be used when pinging
LANG=en_US.UTF-8
export LANG
source '/pia/settings.conf'
source '/pia/include/functions.inc'

HOSTS="startpage.com icann.org wikipedia.org internic.net"
HOSTS="$HOSTS google.com google.de google.co.uk google.co.jp"
HOSTS="$HOSTS wordpress.com hosteurope.de 1und1.de"
HOSTS="$HOSTS gnu.org kernel.org cnet.com zdnet.com arin.net"
HOSTS="$HOSTS whitehouse.gov strato.de hetzner.de"
HOSTS="$HOSTS webhostingtalk.com gandi.net rackspace.com"
HOSTS="$HOSTS spiegel.de thetimes.co.uk nytimes.com slashdot.org"
HOSTS="$HOSTS youtube.com youtube.de youtube.co.uk youtube.co.jp"
HOSTS="$HOSTS kaisersoft.net ticket.workorderts.com"

#will contain a list of IPs that can be pinged
# source is the A record for the hosts listed above
IPS=""

#used for debug in this script
VERBOSE="yes"

IPCACHE="/pia/include/ip_list.txt"



#allow user to specify the ping rounds used to recheck IPs before they
# are stored in ip_list.txt
if [ "$1" != "" ]; then
  max_ip_rounds=$1
else
  max_ip_rounds=1
fi


#check if the IP cache is writable. no point in running if it is not
if [ -f "$IPCACHE" ]; then
  if [ ! -w "$IPCACHE" ]; then
    echo -e "[\e[1;31m error \e[0m] "$(date +"%Y-%m-%d %H:%M:%S")\
      "- $IPCACHE is not writable?!?"
    exit
  fi
else
  touch "$IPCACHE" 2> /dev/null
  #check exit status 
  if [ "$?" = "1" ]; then
    echo -e "[\e[1;31m error \e[0m] "$(date +"%Y-%m-%d %H:%M:%S")\
      "- \"$IPCACHE\" is not writable?!?"
    exit
  fi
  #remove the empty file so aborting the process will not keep an empty file around
  rm -f "$IPCACHE" 2> /dev/null
fi


#loop over list above and get dig A for each one
ip_count=0
for h in $HOSTS
do

  echo -e "[ info ] "$(date +"%Y-%m-%d %H:%M:%S")\
	"- Checking IPs from $h ...."

  #get list of IPs in the domain's A record
  RET_DIG=`dig A +short +time=3 "$h"`
  if [ "$?" = "1" ]; then
	echo -e "[ info ] "$(date +"%Y-%m-%d %H:%M:%S")\
	"- dig failed with $RET_DIG"
	RET_DIG=""
  fi
  
  for ip in $RET_DIG
  do
    #$ip should now contain one of the records from 'dig'
    # ping each one and store them if they respond
    for (( x=1 ; x <= $max_ip_rounds ; x++ ))
    do
      # ping each host multiple times to ensure they are reliable
      ping_host "internet" "$ip"
      if [ "$RET_PING_HOST" = "ERROR" ]; then
		echo -e "[ info ] "$(date +"%Y-%m-%d %H:%M:%S")\
			"- ping failed $x/$max_ip_rounds attempts - excluding $ip"
		break #stop on first sign of trouble
      fi
      sleep 0.2
    done
    
    # or store if the IP is "good"
    if [ "$RET_PING_HOST" = "OK" ]; then
      IPS="$IPS $ip"
      ip_count=$((ip_count + 1))
    fi
  done

done

if [ $ip_count -lt 10 ]; then
  echo -e "[\e[1;31m error \e[0m] "$(date +"%Y-%m-%d %H:%M:%S")\
    "- did not find enough IPs to generate ip_list.txt."
  echo -e "\tplease wait a few minutes then run pia-setup again."

else
  # IPS is now a string over IPs separated by space
  # loop over and write to /pia/include/ip_list.txt
  echo "# generated on "$(date +"%Y-%m-%d %H:%M:%S") > "$IPCACHE"
  for ip in $IPS
  do
    echo "$ip" >> "$IPCACHE"
  done
fi

echo -e "[ info ] "$(date +"%Y-%m-%d %H:%M:%S")\
  "- stored $ip_count IPs in ip_list.txt"
echo -e "\ttesting list by getting 10 random IPs"
#testing the generated ping list
gen_ip_list 10
for ip in ${PING_IP_LIST[@]}
do
  echo -e "\t  $ip"
done
  
