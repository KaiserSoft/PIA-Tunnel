#!/bin/bash
# script to end the tunnel and reset the system back to normal
# note: restarting the network to get the default route back in place

LANG=en_US.UTF-8
export LANG
source '/pia/settings.conf'


if [ "$1" = "verbose" ]; then

    /pia/include/socks-stop.sh

	killall openvpn

	#disable forwarding
	/pia/pia-forward stop

	# restart networking to get default routes through eth0 working again
	# service network restart #CentOS
	ifdown eth0 && ifup eth0 #Debian
	ifdown eth1 && ifup eth1 #Debian

else
    /pia/include/socks-stop.sh &>/dev/null
	killall openvpn &>/dev/null
	/pia/pia-forward stop quite
	ifdown eth0 &>/dev/null && ifup eth0 &>/dev/null #Debian
	ifdown eth1 &>/dev/null && ifup eth1 &>/dev/null #Debian
fi




# attempting to fix an issue where the default GW may be lost when disconnecting the VPN
GATEWAY=`/sbin/ip route show | grep "default via" | gawk -F" " '{print $3}'`
if [ "$GATEWAY" = "" ] && [ "$IF_ETH0_DHCP" = "no" ] && [ "$IF_ETH0_GW" != "" ]; then
  route add default gw $IF_ETH0_GW $IF_EXT

elif [ "$GATEWAY" = "" ] && [ "$IF_ETH1_DHCP" = "no" ] && [ "$IF_ETH1_GW" != "" ]; then
  route add default gw $IF_ETH1_GW $IF_EXT

elif [ "$GATEWAY" = "" ] && ([ "$IF_ETH0_DHCP" = "yes" ] || [ "$IF_ETH1_DHCP" = "yes" ]); then

  #get info from dhcp leases file
  if [ -f "/var/lib/dhcp/dhclient.${IF_EXT}.leases" ]; then
    DHCP_GW_IP=`cat "/var/lib/dhcp/dhclient.${IF_EXT}.leases" | grep -m 1 'option routers' | gawk -F" " '{print $3}' | cut -d';' -f1`
    route add default gw $DHCP_GW_IP $IF_EXT

  else
    echo -e "[\e[1;31mfail\e[0m] "$(date +"%Y-%m-%d %H:%M:%S")\
	  "- No default gateway set and unable to retrieve router value from leases!"\
      " Rebooting should fix this, please contact support if this happens again."
  fi

elif [ "$GATEWAY" = '' ]; then
  echo -e "[\e[1;31mfail\e[0m] "$(date +"%Y-%m-%d %H:%M:%S")\
    "- No default gateway set! This should prevent Internet/VPN access."\
    " Rebooting should fix this, please contact support if this happens again."
fi


# remove old status.txt
rm -f '/pia/cache/status.txt' &>/dev/null
rm -f '/pia/cache/session.log' &>/dev/null
rm -f '/pia/cache/php_pia-start.log' &>/dev/null

exit 0