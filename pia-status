#!/bin/bash
#script to get the current status of the VPN connection and store it in a cache file
#the cache file is periodically refreshed by the caching function
LANG=en_US.UTF-8
export LANG

#config file has been added after the first release so this condition needs to stay here for a while
if [ ! -f "/pia/settings.conf" ]; then
	echo '#!/bin/bash' > '/pia/settings.conf'
	echo 'LANG=en_US.UTF-8' >> '/pia/settings.conf'
	echo 'export LANG' >> '/pia/settings.conf'
	echo '' >> '/pia/settings.conf'
	echo '# name of your external interface. this connects to the Internet/Router' >> '/pia/settings.conf'
	echo 'IF_EXT="eth0"' >> '/pia/settings.conf'
	echo '# name of your internal interface. this if for the private VM network' >> '/pia/settings.conf'
	echo 'IF_INT="eth1"' >> '/pia/settings.conf'
	echo '# name of your VPN interface' >> '/pia/settings.conf'
	echo 'IF_TUNNEL="tun0"' >> '/pia/settings.conf'
	echo '' >> '/pia/settings.conf'
fi
source '/pia/settings.conf'
source '/pia/include/functions.sh'

# check for default username and exit
check_default_username



# create and or maintain the status cache file
maintain_status_cache '/pia/cache/status.txt'
if [ "$?" != "0" ]; then
  echo -e "[\e[1;31mfail\e[0m] "$(date +"%Y-%m-%d %H:%M:%S")\
    "- error during status cache maintenance\n\tpia-status will not work"
  exit
fi




#print connection details
ping_host "vpn" "quick"
vpn_up=$RET_PING_HOST
if [ "$RET_PING_HOST" = "OK" ]; then
  echo -e "[\e[1;32m ok \e[0m] "$(date +"%Y-%m-%d %H:%M:%S")" - VPN is UP!"
  port=`cat "/pia/cache/status.txt" | grep "VPNPORT" | gawk -F":" '{print $2}'`
  if [ "$port" = "none" ]; then
    echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")" - VPN IP: "`grep "TCPv4_CLIENT link remote: \[AF_INET]" /pia/cache/session.log | gawk -F"]" '{print $2}' | gawk -F":" '{print $1}'`" Port: not supported"
  else
    echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")" - VPN IP: "`grep "TCPv4_CLIENT link remote: \[AF_INET]" /pia/cache/session.log | gawk -F"]" '{print $2}' | gawk -F":" '{print $1}'`" Port: $port"
  fi

  echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")" - Public LAN IP: "`cat "/pia/cache/status.txt" | grep "INTERNETIP" | gawk -F":" '{print $2}'`
  echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")" - Private LAN IP: "`cat "/pia/cache/status.txt" | grep "INTIP" | gawk -F":" '{print $2}'`
else
  echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")" - VPN is DOWN!"
  if [ ! -f '/pia/cache/status.txt' ]; then
    echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")" - Public LAN IP: "`/sbin/ip addr show $IF_EXT | grep -w "inet" | gawk -F" " '{print $2}' | cut -d/ -f1`
    echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")" - Private LAN IP: "`/sbin/ip addr show $IF_INT | grep -w "inet" | gawk -F" " '{print $2}' | cut -d/ -f1`
  else
    echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")" - Public LAN IP: "`cat "/pia/cache/status.txt" | grep "INTERNETIP" | gawk -F":" '{print $2}'`
    echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")" - Private LAN IP: "`cat "/pia/cache/status.txt" | grep 	"INTIP" | gawk -F":" '{print $2}'`
  fi
fi

