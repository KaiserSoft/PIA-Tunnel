#!/bin/bash
# script to control the firewall, start and stop for now
LANG=en_US.UTF-8
export LANG
source '/pia/settings.conf'

if [ "$1" = "start" ]; then
	#this needs a loop to check if tun0 exists ... later
	if [ ! "$1" = "quite" ] && [ ! "$2" = "quite" ]; then
		echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")\
			"- turning port forwarding ON"
	fi

	/pia/include/fw-forward.sh
	exit
fi


if [ "$1" = "stop" ] || [ "$2" = "stop" ]; then
	if [ ! "$1" = "quite" ] && [ ! "$2" = "quite" ]; then
		echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")\
			"- turning port forwarding OFF"
	fi
	/pia/include/fw-no-forward.sh
	exit
fi


if [ "$1" = "fix" ]; then
	if [ "$VERBOSE" = "yes" ]; then
		echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")\
			"- running pia-forward fix. This is the current network status"

			echo $(date +"%Y-%m-%d %H:%M:%S")\
						"script pia-forward fix needs to run ... network status right now" >> /pia/cache/network.log
			ifconfig tun0 >> /pia/cache/network.log
			ifconfig eth0 >> /pia/cache/network.log
			ifconfig eth1 >> /pia/cache/network.log
			route -n >> /pia/cache/network.log
  fi

	if [ ! "$1" = "quite" ] && [ ! "$2" = "quite" ]; then
		echo -e "[\e[1;33mwarn\e[0m] "$(date +"%Y-%m-%d %H:%M:%S")\
			"- will attempt to stop any VPN tunnels \n\tand restart all network interfaces"

		killall openvpn 2>/dev/null
    rm -f /pia/cache/status.txt 2>/dev/null
		/pia/include/fw-no-forward.sh
		# restart networking to get default routes through eth0 working again
		# service network restart #CentOS
		ifdown eth0 && ifup eth0 #Debian
	else
		killall openvpn 2>/dev/null
		/pia/include/fw-no-forward.sh
		ifdown eth0 2>/dev/null	 && ifup eth0 2>/dev/null
	fi

	echo -e "[info] "$(date +"%Y-%m-%d %H:%M:%S")" - Done! Please try again."
fi
